<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watchdog: watchdog.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Watchdog
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">watchdog.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Codes of the Watchdog process. It monitors the system and restarts dead processes.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;string&gt;</code><br />
<code>#include &lt;fstream&gt;</code><br />
<code>#include &lt;csignal&gt;</code><br />
<code>#include &lt;sys/stat.h&gt;</code><br />
<code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;sys/wait.h&gt;</code><br />
<code>#include &lt;fcntl.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;iostream&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a83f03ce1009f34178acc314d0e770524"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a83f03ce1009f34178acc314d0e770524">execOneChild</a> (int index, int *array_of_process_ids)</td></tr>
<tr class="memdesc:a83f03ce1009f34178acc314d0e770524"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function forks a <a class="el" href="process_8cpp.html">process.cpp</a> and execs it with given index parameter, finally sends necessary message to executor using pipe ( <a class="el" href="watchdog_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a>).  <a href="watchdog_8cpp.html#a83f03ce1009f34178acc314d0e770524">More...</a><br /></td></tr>
<tr class="separator:a83f03ce1009f34178acc314d0e770524"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75fdc6b963242ab8b0347bf9a6290bde"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a75fdc6b963242ab8b0347bf9a6290bde">execChildren</a> (int *array_of_process_ids)</td></tr>
<tr class="memdesc:a75fdc6b963242ab8b0347bf9a6290bde"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calls <a class="el" href="watchdog_8cpp.html#a83f03ce1009f34178acc314d0e770524">execOneChild()</a> function <a class="el" href="watchdog_8cpp.html#ad40dac89bb0531c14fb75e6b17762331">number_of_processes</a> times.  <a href="watchdog_8cpp.html#a75fdc6b963242ab8b0347bf9a6290bde">More...</a><br /></td></tr>
<tr class="separator:a75fdc6b963242ab8b0347bf9a6290bde"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a543cdbd34c6cf14c0b950799768c7764"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a543cdbd34c6cf14c0b950799768c7764">findIndex</a> (int value, int *array_of_process_ids)</td></tr>
<tr class="memdesc:a543cdbd34c6cf14c0b950799768c7764"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find and return the index of the killed process in array, -1 if not found.  <a href="watchdog_8cpp.html#a543cdbd34c6cf14c0b950799768c7764">More...</a><br /></td></tr>
<tr class="separator:a543cdbd34c6cf14c0b950799768c7764"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aac05b61978ba1b41eb757c495dd80dc3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#aac05b61978ba1b41eb757c495dd80dc3">sigtermHandler</a> (int i)</td></tr>
<tr class="memdesc:aac05b61978ba1b41eb757c495dd80dc3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sigterm signal handler When everything ends, executor sends a signal to watchdog and watchdog terminates gracefully.  <a href="watchdog_8cpp.html#aac05b61978ba1b41eb757c495dd80dc3">More...</a><br /></td></tr>
<tr class="separator:aac05b61978ba1b41eb757c495dd80dc3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0ddf1224851353fc92bfbff6f499fa97"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
<tr class="memdesc:a0ddf1224851353fc92bfbff6f499fa97"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main method of the project.  <a href="watchdog_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">More...</a><br /></td></tr>
<tr class="separator:a0ddf1224851353fc92bfbff6f499fa97"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:afb04ed65b5ea994e05352e08ccf5a96a"><td class="memItemLeft" align="right" valign="top"><a id="afb04ed65b5ea994e05352e08ccf5a96a"></a>
std::ofstream&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#afb04ed65b5ea994e05352e08ccf5a96a">watchdog_output_file</a></td></tr>
<tr class="memdesc:afb04ed65b5ea994e05352e08ccf5a96a"><td class="mdescLeft">&#160;</td><td class="mdescRight">File that watchdog writes. <br /></td></tr>
<tr class="separator:afb04ed65b5ea994e05352e08ccf5a96a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a23b36c8ed1acf7c37d01df0c77a59350"><td class="memItemLeft" align="right" valign="top"><a id="a23b36c8ed1acf7c37d01df0c77a59350"></a>
std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a23b36c8ed1acf7c37d01df0c77a59350">process_output_path</a></td></tr>
<tr class="memdesc:a23b36c8ed1acf7c37d01df0c77a59350"><td class="mdescLeft">&#160;</td><td class="mdescRight">Path of the file that processes will write their messages, watchdog just passes to each <a class="el" href="process_8cpp.html">process.cpp</a> while exec()ing. <br /></td></tr>
<tr class="separator:a23b36c8ed1acf7c37d01df0c77a59350"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a94b30caa003528865b648786955849aa"><td class="memItemLeft" align="right" valign="top"><a id="a94b30caa003528865b648786955849aa"></a>
std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a94b30caa003528865b648786955849aa">watchdog_output_path</a></td></tr>
<tr class="memdesc:a94b30caa003528865b648786955849aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Path of the file that watcHdog will write its messages. <br /></td></tr>
<tr class="separator:a94b30caa003528865b648786955849aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad40dac89bb0531c14fb75e6b17762331"><td class="memItemLeft" align="right" valign="top"><a id="ad40dac89bb0531c14fb75e6b17762331"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#ad40dac89bb0531c14fb75e6b17762331">number_of_processes</a></td></tr>
<tr class="memdesc:ad40dac89bb0531c14fb75e6b17762331"><td class="mdescLeft">&#160;</td><td class="mdescRight">Total number of all processes. It will be given as a command line argument. <br /></td></tr>
<tr class="separator:ad40dac89bb0531c14fb75e6b17762331"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a320b747b530b47d5a291a857d2f5d355"><td class="memItemLeft" align="right" valign="top"><a id="a320b747b530b47d5a291a857d2f5d355"></a>
char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a320b747b530b47d5a291a857d2f5d355">myfifo</a> = &quot;/tmp/myfifo&quot;</td></tr>
<tr class="memdesc:a320b747b530b47d5a291a857d2f5d355"><td class="mdescLeft">&#160;</td><td class="mdescRight">Location of the pipe. <br /></td></tr>
<tr class="separator:a320b747b530b47d5a291a857d2f5d355"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f8059414f0228f0256115e024eeed4b"><td class="memItemLeft" align="right" valign="top"><a id="a6f8059414f0228f0256115e024eeed4b"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="watchdog_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a></td></tr>
<tr class="memdesc:a6f8059414f0228f0256115e024eeed4b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Names of the pipe. We will communicate with executor.cpp using this pipe. <br /></td></tr>
<tr class="separator:a6f8059414f0228f0256115e024eeed4b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Codes of the Watchdog process. It monitors the system and restarts dead processes. </p>
<dl class="section author"><dt>Author</dt><dd>Adalet Veyis Turgut 2017400210</dd></dl>
<p>Detailed explanation is given in <a class="el" href="watchdog_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97" title="Main method of the project.">main()</a> method.</p>
<dl class="section date"><dt>Date</dt><dd>2020-12-26 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a75fdc6b963242ab8b0347bf9a6290bde"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a75fdc6b963242ab8b0347bf9a6290bde">&#9670;&nbsp;</a></span>execChildren()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void execChildren </td>
          <td>(</td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>array_of_process_ids</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calls <a class="el" href="watchdog_8cpp.html#a83f03ce1009f34178acc314d0e770524">execOneChild()</a> function <a class="el" href="watchdog_8cpp.html#ad40dac89bb0531c14fb75e6b17762331">number_of_processes</a> times. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">array_of_process_ids</td><td>Array of pids of all processes </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a83f03ce1009f34178acc314d0e770524"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a83f03ce1009f34178acc314d0e770524">&#9670;&nbsp;</a></span>execOneChild()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void execOneChild </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>array_of_process_ids</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function forks a <a class="el" href="process_8cpp.html">process.cpp</a> and execs it with given index parameter, finally sends necessary message to executor using pipe ( <a class="el" href="watchdog_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a>). </p>
<p>First, it forks a child process. Then, updates the corresponding value of pid array and sends "Px pidxx" message to executor with pipe in parent part. On the other hand, child part writes to the watchdog output file and exec()s the process with given parameter index.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">index</td><td>Id of the process. </td></tr>
    <tr><td class="paramname">array_of_process_ids</td><td>Array of pids of all processes. </td></tr>
  </table>
  </dd>
</dl>
<p>Try to fork</p>
<p>Fork failed, exit.</p>
<p>We are in child, write to file ( <a class="el" href="watchdog_8cpp.html#afb04ed65b5ea994e05352e08ccf5a96a">watchdog_output_file</a>) that process is started and exec().</p>
<p>Here I used execv(). It takes arguments as an array. As usual first argument(argv[0]) is the process itself. Second and third are id and <a class="el" href="watchdog_8cpp.html#a23b36c8ed1acf7c37d01df0c77a59350">process_output_path</a>. Finish the array with NULL. Since it is a C function, there are no strings. Changing string to char array is cumbersome.</p>
<p>We are in parent, update the array_of_process_ids and write pid of the child process to pipe. Add sleep(1) for synchronization.</p>

</div>
</div>
<a id="a543cdbd34c6cf14c0b950799768c7764"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a543cdbd34c6cf14c0b950799768c7764">&#9670;&nbsp;</a></span>findIndex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int findIndex </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>array_of_process_ids</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Find and return the index of the killed process in array, -1 if not found. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">value</td><td>Pid of the killed process </td></tr>
    <tr><td class="paramname">array_of_process_ids</td><td>Array of pids of all processes </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Integer index of the killed process </dd></dl>

</div>
</div>
<a id="a0ddf1224851353fc92bfbff6f499fa97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ddf1224851353fc92bfbff6f499fa97">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main method of the project. </p>
<p>We start with reading command line arguments and initializing global variables. If there is something wrong with arguments, we simply quit. Then open the pipe and send the watchdog pid to executor. Initiate all the processes by fork() and exec(). Send their pids to executor and wait-sleep until one the children dies. If dead child is P1 then kill all children and restart one by one, else just restart the dead process. If executor sends a sigterm signal, terminate gracefully.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">argc</td><td>count of command line arguments </td></tr>
    <tr><td class="paramname">argv</td><td>array of command line arguments </td></tr>
  </table>
  </dd>
</dl>
<p>Initialize global variables with given command line arguments</p>
<p>Open the watchdog file with given path <a class="el" href="watchdog_8cpp.html#a94b30caa003528865b648786955849aa">watchdog_output_path</a></p>
<p>Open the pipe <a class="el" href="watchdog_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a></p>
<p>Send watchdog's pid to executor: "P0 pidxxx"</p>
<p>Initiate the processes</p>
<p>Map sigterm signal with its handler fucntion <a class="el" href="watchdog_8cpp.html#aac05b61978ba1b41eb757c495dd80dc3">sigtermHandler</a></p>
<p>Wait, do nothing, sleep. Until one of the processes dies.</p>
<p>P1 is killed, kill others and restart all.</p>
<p>One of the other processes is killed, restart it.</p>

</div>
</div>
<a id="aac05b61978ba1b41eb757c495dd80dc3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aac05b61978ba1b41eb757c495dd80dc3">&#9670;&nbsp;</a></span>sigtermHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sigtermHandler </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>i</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sigterm signal handler When everything ends, executor sends a signal to watchdog and watchdog terminates gracefully. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">i</td><td>Equals to 15. Value of sigterm signal. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.0
</small></address>
</body>
</html>
